<svelte:head>
  <title>Blog</title>
</svelte:head>

<div class="w3-container {!$isMobile && 'w3-margin'}">
  <h3 class="w3-text-teal">Blog</h3>

  {#if Boolean(blogs)} 
    {#each blogs as blog}
    <div class="w3-row">
      <div class="w3-col s9"><a class="w3-large w3-text-orange" href="blog/{blog.slug}">{blog.title}</a></div>
      <div class="w3-col s3">
        <span class="w3-right w3-small w3-text-grey">
          {blog.timestamp} by <a href="/users/{blog.userId}" class="w3-text-blue">{blog.username}</a>
        </span>
      </div>
    </div>
    <div><a href="blog/{blog.slug}">{@html blog.content}</a></div>
    <hr />
    {/each} 
  {/if}
</div>

<script>
  import * as sapper from '../../../__sapper__/client'

  export default {
    preload(params) {
      if ( this.store.get().isAuth === false ) {
        return this.redirect(301, '/')
      }
    },

    data() {
      return {
        blogs: []
      }
    },
    
    async oncreate() {
      try {
        let res = await fetch(`/${this.store.get().CFG.API_VERSION}/blog`, {
          method: 'GET',
          credentials: 'same-origin',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        }).then(res => res.json())
        if (res.error) {
          throw res.error
        }
        this.set({ blogs: res.blogs })
      } catch (err) {
        this.set({ blogs: [] })
      }
    }

  }
</script>

<svelte:head>
	<title>{blog.title}</title>
</svelte:head>

{#if Boolean(blog)}
<div class="w3-container {!$isMobile && 'w3-margin'}">
	<h3>
		<a href="/blog" class="w3-text-blue">Blog</a> <i class="fas fa-chevron-right w3-text-orange"/> <span class="w3-text-teal">{blog.title}</span>
	</h3>
	<div class="w3-row">
		<div class="w3-col s12">
			<span class="w3-right w3-small w3-text-grey">
				{blog.timestamp} by <a href="/users/{blog.userId}" class="w3-text-blue">{blog.username}</a>
			</span>
		</div>
	</div>
	<div>
			{@html blog.content}
	</div>

	<div class="w3-padding w3-center">
		<h4>
				{#if Boolean(nextSlug)}
					<a href="/blog/{nextSlug}"><i class="fas fa-chevron-left w3-text-orange"/>&nbsp;Next article</a>
				{/if}	
				&nbsp;&nbsp;<a href="/blog" class="w3-text-blue">Blog</a>&nbsp;&nbsp;
				{#if Boolean(prevSlug)}
					<a href="/blog/{prevSlug}">Previous article&nbsp;<i class="fas fa-chevron-right w3-text-orange"/></a>
				{/if}
		</h4>
	</div>
</div>
{/if}

<script>
	import * as sapper from '../../../__sapper__/client'

	export default {
		preload(params) {
      if ( this.store.get().isAuth === false ) {
        return this.redirect(301, '/')
      }
		},
		
		data() {
			return {
				blog: {},
				nextSlug: null,
				prevSlug: null
			}
		},

		async oncreate() {
			try {
				let res = await fetch(`/${this.store.get().CFG.API_VERSION}/blog/${this.get().params.slug}`, {
					method: 'GET',
					credentials: 'same-origin',
					headers: {
						Accept: 'application/json',
						'Content-Type': 'application/json',
					}
				}).then(res => res.json())

				if (res.error) {
					throw res.error
				}
				this.set({ 
					blog: res.blog, 
					nextSlug: res.nextSlug, 
					prevSlug: res.prevSlug
				})
			} catch (err) {
				this.set({ blog: null, nextSlug: null, prevSlug: null })
			}
		}

	}
</script>
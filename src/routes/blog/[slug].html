<svelte:head>
	<title>{blog.title}</title>
</svelte:head>

{#if Boolean(blog)}
<div class="w3-container {!$isMobile && 'w3-margin'}">
	<h3 class="nowrap">
		<a href="/blog" class="w3-text-blue">Blog</a>&nbsp;<i class="fas fa-chevron-right w3-text-orange"/>
		{#if editMode }
			<input type="text" class="title w3-border-0 w3-border-bottom w3-text-teal" bind:value="blog.title"/>
		{:else}
			<input type="text" class="title w3-border-0 w3-border-bottom w3-border-white w3-text-teal" value="{blog.title}" disabled/>
		{/if}
	</h3>
	<div class="w3-row w3-margin-bottom">
		<div class="w3-col s9">
			{#if $isAuth }
				<!-- menu items that required to be auth -->
				<span class="w3-bar">
					{#if editMode }
						<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleUndo()">
							<i class="fas fa-undo w3-text-orange"/>
						</button>
						<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleSave()">
							<i class="fas fa-save w3-text-blue"/>
						</button>
						{#if blog.slug !== '_new' }
							<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleDelete()">
								<i class="fas fa-trash-alt w3-text-red"/>
							</button>
						{/if}
					{:else}
						<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleEdit()">
							<i class="fas fa-edit w3-text-blue"/>
						</button>
						<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleClone()">
							<i class="fas fa-clone w3-text-orange"/>
						</button>
						<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleDelete()">
							<i class="fas fa-trash-alt w3-text-red"/>
						</button>					
						<button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleNew()">
							<i class="fas fa-plus w3-text-teal"/>
						</button>
					{/if}
				</span>
			{:else}
				&nbsp;
			{/if}
		</div>
		<div class="w3-col s3">
			<span class="w3-right w3-small w3-text-grey w3-right-align">
					<span class="nowrap">{blog.timestamp}</span>
					<span class="nowrap"> by <a href="/users/{blog.createdBy}" class="w3-text-blue">{blog.username}</a><span/>
			</span>
		</div>
	</div>
	{#if editMode }
		<!--  $isResize is used to trigger an onupdate -->
		<div id="content" resize="{$isResize}"/>
	{:else}
		<div id="content">
				{@html blog.content}
		</div>
		<div class="w3-padding w3-center">
			<h4>
					{#if Boolean(nextSlug)}
						<a href="/blog/{nextSlug}"><i class="fas fa-chevron-left w3-text-orange"/>&nbsp;Next article</a>
					{/if}	
					&nbsp;&nbsp;<a href="/blog" class="w3-text-blue">Blog</a>&nbsp;&nbsp;
					{#if Boolean(prevSlug)}
						<a href="/blog/{prevSlug}">Previous article&nbsp;<i class="fas fa-chevron-right w3-text-orange"/></a>
					{/if}
			</h4>
		</div>
	{/if}
</div>
{/if}

<style>
	.nowrap {
		white-space:nowrap;
	}

	.title {
		min-width:75%;
	}
</style>

<script>
	import Editor from 'cl-editor'
	import * as sapper from '../../../__sapper__/client'

	let editor

	export default {
		// preload(params) {
    //   if ( this.store.get().isAuth === false ) {
    //     return this.redirect(301, '/')
    //   }
		// },
		
		data() {
			return {
				blog: {
					title : '',
					html: ''
				},
				nextSlug: null,
				prevSlug: null,
				editMode: false
			}
		},

		async oncreate() {
			if( this.get().params.slug === '_new' ) {
				if( this.store.get().isAuth === false ){
					return sapper.goto('/blog')
				}
				return this.handleNew()
			}
			try {
				let res = await fetch(`/${this.store.get().CFG.API_VERSION}/blog/${this.get().params.slug}`, {
					method: 'GET',
					credentials: 'same-origin',
					headers: {
						Accept: 'application/json',
						'Content-Type': 'application/json',
					}
				}).then(res => res.json())

				if (res.error) {
					throw res.error
				}
				this.set({ 
					blog: res.blog, 
					nextSlug: res.nextSlug, 
					prevSlug: res.prevSlug
				})
			} catch (err) {
				this.set({ blog: null, nextSlug: null, prevSlug: null })
			}
		},

		onupdate({changed, current}) {
			if( changed.$isResize && current.editMode) {
				// set new height for editor editable content
				this.editor.set({height: this.contentHeight()})
			}
		},

		methods: {
			contentHeight() {
				return `${Math.max(100, window.innerHeight-(document.getElementById('content').getBoundingClientRect().top+50))}px`
			},

			handleEdit() {
				this.set({ editMode: true})

				this.editor = new Editor({
					// <HTMLElement> required
					target: document.getElementById('content'),
					// optional
					data: {
						// <Array[string | Object]> string if overwriting, object if customizing/creating
						// available actions:
						// 'viewHtml', 'undo', 'redo', 'b', 'i', 'u', 'strike', 'sup', 'sub', 'h1', 'h2', 'p', 'blockquote', 
						// 'ol', 'ul', 'hr', 'left', 'right', 'center', 'justify', 'a', 'image', 'forecolor', 'backcolor', 'removeFormat'
						actions: [
							'b', 'i', 'u', 'strike', 'ul', 'ol',
							{
								name: 'copy', // required
								icon: '<i class="far fa-copy"/>', // string or html string (ex. <svg>...</svg>)
								title: 'Copy',
								result: () => {
									// copy current selection or whole editor content
									const selection = window.getSelection();
									if (!selection.toString().length) {
										const range = document.createRange();
										range.selectNodeContents(editor.refs.editor);
										selection.removeAllRanges();
										selection.addRange(range);
									}
									editor.exec('copy');
								}
							},
							'h1', 'p', 'image'
						],
						// default 300px
						height: this.contentHeight(),
						// initial html
						html: this.get().blog.content,
						// remove format action clears formatting, but also removes some html tags.
						// you can specify which tags you want to be removed.
						// removeFormatTags: ['h1', 'h2', 'blackquote'] // default
					}
				})
			},

			handleUndo() {
				console.log('blog/slug/handleUndo', this.get(), this.store.get())

				if( this.get().blog.slug === '_new') {
					return sapper.goto('/blog')
				}
				this.set({ editMode: false})
			},

			handleClone() {
			},

			async handleDelete() {
				if( this.get().blog.slug === '_new') {
					return sapper.goto('/blog')
				}
				try {
					let res = await fetch(`/${this.store.get().CFG.API_VERSION}/blog/${this.get().params.slug}`, {
						method: 'DELETE',
						credentials: 'same-origin',
						headers: {
							Accept: 'application/json',
							'Content-Type': 'application/json',
						},
					}).then(res => res.json())

					if (res.error) {
						throw res.error
					}

					return sapper.goto('/blog')

				} catch (err) {
					this.set({ blog: null, nextSlug: null, prevSlug: null })
				}
			},
			
			handleNew() {
				this.set({ 
					blog: {
						title: 'New blog',
						content: '',
						timestamp: '',
						username: this.store.get().user.username
					}
				})
				return this.handleEdit()
			},
			
			async handleSave() {

				let formData = Object.assign({}, this.get().blog, {html:this.editor.getHtml()})
				console.log("blog/handleSave", formData, this.get().params)
				
				try {
					let apiUrl = this.get().params.slug === '_new' ? '' : `/${this.get().params.slug}`
					let res = await fetch(`/${this.store.get().CFG.API_VERSION}/blog${apiUrl}`, {
						method: 'POST',
						credentials: 'same-origin',
						headers: {
							Accept: 'application/json',
							'Content-Type': 'application/json',
						},
      			body: JSON.stringify(formData),
					}).then(res => res.json())

					if (res.error) {
						throw res.error
					}
					this.set({ 
						blog: res.blog, 
						nextSlug: res.nextSlug, 
						prevSlug: res.prevSlug
					})
					history.replaceState(history.state, 'blog', `/blog/${res.blog.slug}`)
					this.set({params:{slug:res.blog.slug}})

				} catch (err) {
					this.set({ blog: null, nextSlug: null, prevSlug: null })
				}
			}
		}
	}
</script>
<svelte:head>
  <title>Forum</title>
</svelte:head>

<div class="w3-container {!$isMobile && 'w3-margin'}">

  <div class="w3-row">
    <div class="w3-col l1 s2">
      <h3 class="w3-text-teal">Forum</h3>
    </div>
    
    {#if $isAuth }
      <div class="w3-col l1 s3">
        <button class="w3-button w3-middle w3-card w3-round w3-hover-light-grey" on:click="handleNew()">
          <i class="fas fa-plus w3-text-teal"/>
        </button>
      </div>
    {/if}

    <div class="w3-col l10 s7">
      <SearchWithTags
        componentClass="w3-margin-bottom"
        inputClass="w3-input"
        popupClass=""
        placeholder="Search... spacebar for Tags"
        on:click="searchForum(event, test)"
        data="{countries}"
        bind:selectedTags="filterByTags"
      />
    </div>
  </div>
  {#if Boolean(posts)} 
    <div class="w3-margin-top">
      {#each posts as post}
        <div class="w3-row">
          <div class="w3-col m8 s9"><a class="w3-large w3-text-orange" href="/forum/{post.slug}">{post.title}</a></div>
          <div class="w3-col m4 s3">
            <span class="w3-right w3-small w3-text-grey w3-right-align">
              <span class="nowrap">{post.timestamp}</span>
              <span class="nowrap"> by <a href="/user/{post.createdBy}" class="w3-text-blue">{post.username}</a><span/>
            </span>
          </div>
        </div>
        <div><a href="/forum/{post.slug}">{@html post.html}</a></div>
        {#if post.tags}
          <div class="w3-row w3-margin-top">
            {#each post.tags as tag}
              <span class="pointer w3-tag w3-round w3-margin-right w3-small w3-light-gray w3-center" 
                on:click="addFilterByTag(event, tag)">{tag.name}</span>
            {/each}
          </div>
        {/if}
        <hr />
      {/each}
    </div>
  {/if}
</div>

<style>
  .nowrap {
    white-space:nowrap;
  }
</style>

<script>
  import * as sapper from '../../../__sapper__/client'

  import countries from './countries.json'
  
  export default {
    components: {
			SearchWithTags: '../../components/SearchWithTags.html'
    },
    
    data() {
      return {
        posts: [],
        filterByTags: [],
        countries,
      }
    },
    
    async oncreate() {
      try {
        let res = await fetch(`/${this.store.get().CFG.API_VERSION}/forum`, {
          method: 'GET',
          credentials: 'same-origin',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        }).then(res => res.json())
        if (res.error) {
          throw res.error
        }
        this.set({ posts: res.posts })
      } catch (err) {
        this.set({ posts: [] })
      }
    },

    methods: {
			handleNew() {
        sapper.goto('/forum/_new')
      },

			addFilterByTag(evt, tag) {
        evt.preventDefault()
        evt.stopPropagation()
        console.log('forum/addFilterByTag', tag)
        let tags = this.get().filterByTags || []
				if( !tags.find(t => t.code === tag.code) ) {
					tags.push({
						code: tag.code,
						name: tag.name
					})
        }
        this.set({filterByTags: tags})
      },

			removeFilterByTag(evt, tag) {
				evt.preventDefault()
        evt.stopPropagation()
        console.log('forum/removeFilterByTag', tag)
				this.set({filterByTags: this.get().filterByTags.filter(t => t.code != tag.code)})
			},

			searchForum({event, test}) {
				event.preventDefault()
        event.stopPropagation()
        console.log('forum/searchForum', test)
				// this.set({filterByTags: this.get().filterByTags.filter(t => t.code != tag.code)})
			},
    }

  }
</script>

<svelte:head>
  <title>Forum</title>
</svelte:head>

<div class="w3-container {!$isMobile && 'w3-margin'}">

  <!-- Search  -->
  <div class="w3-row">
    <div class="w3-col m2 s3">
      <div class="w3-text-teal w3-xlarge">Forum</div>
    </div>

    <div class="w3-col s6">
      <div class="w3-row">
        <button class="w3-button w3-left w3-light-grey w3-hover-orange w3-text-grey" on:click="setSearchFilter()">
          <i class="fas fa-search"/>
        </button>
        <div class="w3-rest">
          <input class="w3-input w3-border-0 w3-light-grey"
            placeholder="Search..."
            bind:value="search"
            on:keydown="setSearchFilter(event)"
          />
        </div>
      </div>
    </div>

    {#if $isAuth }
      <div class="w3-col w3-right s2">
        <button class="w3-right w3-button w3-card w3-teal w3-hover-orange w3-hover-text-black" on:click="handleNew()">
          <i class="fas fa-plus"/><span class="w3-hide-small">&nbsp;New post</span>
        </button>
      </div>
    {/if}

  </div>

<!-- Tags -->
<div class="tags w3-display-container w3-margin-top w3-hide-large w3-hide-medium">
    <div class="w3-container w3-border w3-border-light-grey w3-padding w3-white">
      {#each tags as tag}
        <span class="tag pointer w3-tag w3-round w3-small {tag.selected ? 'w3-blue' : 'w3-light-grey'} w3-center" 
          on:click="setTagFilter(event, tag)">{tag.name}</span>
      {/each}
      <div class="w3-display-topright w3-text-orange">
        <i class="fas fa-angle-down" on:click="toggleTags(event)"/>
      </div>
    </div>
  </div>

  <div class="w3-row">
      <div class="w3-col w3-right s3 w3-hide-small">
        <!-- Tags -->
        <div class="w3-display-container w3-margin-top w3-border w3-border-light-grey w3-light-grey">
          <div class="w3-container w3-lightgrey">
            Tags
          </div>
          <div class="w3-container w3-padding w3-white">
            {#each tags as tag}
              <span class="tag pointer w3-tag w3-round w3-small {tag.selected ? 'w3-blue' : 'w3-light-grey'} w3-center" 
                on:click="setTagFilter(event, tag)">{tag.name}</span>
            {/each}
          </div>
        </div>
      </div>

      <div class="w3-col m9 s12">
        <!-- Posts -->
        <div class="w3-margin-right w3-margin-top">
          {#if posts.length }
            {#each posts as post}
              <div class="w3-section">
                <a class="w3-large w3-text-orange" href="/forum/{post.slug}">{post.title}</a>
                <div class="w3-text-grey">
                  {post.html}
                </div>
              </div>
              <div class="w3-row">
                  <div class="w3-col l1 m2 s4">
                    <div class="w3-small w3-text-teal">
                      <i class="far fa-star"/>&nbsp;<span class="w3-text-grey">22</span><br/>
                      <i class="far fa-eye"/>&nbsp;<span class="w3-text-grey">456</span><br/>
                      <i class="far fa-comment-alt"/>&nbsp;<span class="w3-text-grey">3</span><br/>
                    </div>
                  </div>
                  <div class="w3-col l7 m5 w3-hide-small">
                    {#each post.tags as tag}
                      <span class="pointer w3-tag w3-round w3-margin-right w3-tiny {selected(tag.code, tags) ? 'w3-blue' : 'w3-light-grey'} w3-center" 
                        on:click="setTagFilter(event, tag)">{tag.name}</span>
                    {/each}
                  </div>
                  <div class="w3-col l4 m5 s8 w3-right">
                    <div class="w3-small w3-right-align w3-text-grey">{post.timestamp}</div>
                    <div class="w3-small w3-right-align">
                      <a href="/user/{post.createdBy}" class="w3-text-blue">{post.username}</a>
                    </div>
                    <div class="w3-tiny w3-right-align w3-text-grey">
                        <i class="far fa-comment-alt"/>&nbsp;{post.comments}&nbsp;&nbsp;
                      <i class="fas fa-trophy w3-text-amber"/>&nbsp;{post.timestamp}&nbsp;&nbsp;
                      <i class="far fa-thumbs-up w3-text-light-green"/>&nbsp;22&nbsp;&nbsp;
                      <i class="far fa-flag w3-text-purple"/>&nbsp;3
                    </div>
                  </div>
                </div>
              <div class="w3-hide-large w3-hide-medium">
                {#each post.tags as tag}
                  <span class="pointer w3-tag w3-round w3-margin-right w3-tiny {selected(tag.code, tags) ? 'w3-blue' : 'w3-light-grey'} w3-center" 
                    on:click="setTagFilter(event, tag)">{tag.name}</span>
                {/each}
              </div>
              <hr/>
            {/each}
          {:else}
            <div class="w3-padding-64">
              <h4 class="w3-center w3-text-grey">
                Refine the search to display some posts
              </h4>
            </div>
          {/if}
        </div>
      </div>
    </div>


</div>

<style>
  hr {
    border-style: dashed;
    margin-top: 8px;
    margin-bottom: 8px;
  }

  .nowrap {
    white-space:nowrap;
  }

  .tags {
    min-height: 3rem;
  }

  .tags .w3-container {
    position: absolute;
    height: 2.6rem;
    overflow-y: hidden;
  }

  .tags:hover .w3-container {
    height: unset;
    overflow-y: unset;
    z-index: 10;
  }

  .tags i {
	  margin: 12px 10px;
	}

  .tag {
		margin: 4px 8px 8px 0px;
	}

  .tag:hover {
		margin: 4px 8px 4px 0px;
	}
</style>

<script>
  import * as sapper from '../../../__sapper__/client'

  import {fetchPosts} from './_post'
  import {fetchTags} from './_tag'
  
  export default {
    data() {
      return {
        search: '',
        posts: [],
        tags: [],
        selectedTags: []
      }
    },

    helpers: {
      selected: (code, tags) => {
        let tag = tags.find(t => t.code === code)
        return tag && tag.selected
      }
    },
    
    async oncreate() {
      let posts = await fetchPosts(this.store, {search:'', tags:[]})
      posts.forEach( post => post.tags = this.sortTags(post.tags))
      let tags = await fetchTags(this.store)
      this.set({
        posts, 
        tags: this.sortTags(tags)
      })
    },

    methods: {
			handleNew() {
        sapper.goto('/forum/_new')
      },

      // toggle tag as selected/unselected
			async setTagFilter(evt, tag) {
        evt.preventDefault()
        evt.stopPropagation()
        let tags = this.get().tags || []
        let selectedTags = []
				tags.map(t => {
          if( t.code === tag.code) {
            t.selected = !t.selected
          }
          t.selected && selectedTags.push(t.code)
        })

        let posts = await fetchPosts(this.store, {search: this.get().search, tags: selectedTags})
        posts.forEach( post => post.tags = this.sortTags(post.tags))
        this.set({
          posts, 
          selectedTags,
          tags: this.sortTags(tags)
        })
      },

      // toggle tag as selected/unselected
			async setSearchFilter(evt = null) {

        if( evt && evt.key !== 'Enter') {
          return
        }

        console.log('search', this.get().search)


        let posts = await fetchPosts(this.store, {search: this.get().search, tags: this.get().selectedTags})
        posts.forEach( post => post.tags = this.sortTags(post.tags))
        this.set({
          posts
        })
      },

      // sort tags by selected/unselected then name
      sortTags(tags) {
        let selected = []
        let rest = []

        tags.map(t => Boolean(t.selected) ? selected.push(t) : rest.push(t))

        const compare = (a,b) => (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0)
        selected.sort(compare)
        rest.sort(compare)

        return selected.concat(rest)
      },

      // if mobile
			toggleTags(evt) {
				evt.preventDefault()
        evt.stopPropagation()
        let card = document.querySelector('.tags .w3-card')
        if( card.style.height === 'unset') {
          card.style['height'] = '2.6em'
          card.style['overflow-y'] = 'hidden'
        } else {
          card.style['height'] = 'unset'
          card.style['overflow-y'] = 'unset'
        }
      }
    }

  }
</script>

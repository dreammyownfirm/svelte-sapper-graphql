<svelte:head>
  <title>Forum</title>
</svelte:head>

<div class="w3-container {!$isMobile && 'w3-margin'}">
  <h3 class="w3-text-teal">Forum</h3>
  
  {#if $isAuth }
    <!-- menu items that required to be auth -->
    <button class="w3-button w3-card w3-round w3-hover-light-grey" on:click="handleNew()">
      <i class="fas fa-plus w3-text-teal"/>
    </button>
  {/if}
  {#if filterByTags}
    <div class="w3-margin-top">
      {#each filterByTags as tag}
        <span class="tag w3-tag w3-round w3-margin-right w3-blue w3-center">
          {tag.name}
          &nbsp;
          <i on:click="removeFilterByTag(event, tag)" class="fas fa-times-circle pointer" />
        </span>
      {/each}
    </div>
  {/if}
  {#if Boolean(posts)} 
    <div class="w3-margin-top">
      {#each posts as post}
        <div class="w3-row">
          <div class="w3-col m8 s9"><a class="w3-large w3-text-orange" href="/forum/{post.slug}">{post.title}</a></div>
          <div class="w3-col m4 s3">
            <span class="w3-right w3-small w3-text-grey w3-right-align">
              <span class="nowrap">{post.timestamp}</span>
              <span class="nowrap"> by <a href="/user/{post.createdBy}" class="w3-text-blue">{post.username}</a><span/>
            </span>
          </div>
        </div>
        <div><a href="/forum/{post.slug}">{@html post.html}</a></div>
        {#if post.tags}
          <div class="w3-row w3-margin-top">
            {#each post.tags as tag}
              <span class="pointer w3-tag w3-round w3-margin-right w3-small w3-light-gray w3-center" 
                on:click="addFilterByTag(event, tag)">{tag.name}</span>
            {/each}
          </div>
        {/if}
        <hr />
      {/each}
    </div>
  {/if}
</div>

<style>
  .nowrap {
    white-space:nowrap;
  }
</style>

<script>
  import * as sapper from '../../../__sapper__/client'

  export default {
    data() {
      return {
        posts: [],
        filterByTags: []
      }
    },
    
    async oncreate() {
      try {
        let res = await fetch(`/${this.store.get().CFG.API_VERSION}/forum`, {
          method: 'GET',
          credentials: 'same-origin',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        }).then(res => res.json())
        if (res.error) {
          throw res.error
        }
        this.set({ posts: res.posts })
      } catch (err) {
        this.set({ posts: [] })
      }
    },

    methods: {
			handleNew() {
        sapper.goto('/forum/_new')
      },

			addFilterByTag(evt, tag) {
        evt.preventDefault()
        evt.stopPropagation()
        console.log('forum/addFilterByTag', tag)
        let tags = this.get().filterByTags || []
				if( !tags.find(t => t.code === tag.code) ) {
					tags.push({
						code: tag.code,
						name: tag.name
					})
        }
        this.set({filterByTags: tags})
      },

			removeFilterByTag(evt, tag) {
				evt.preventDefault()
        evt.stopPropagation()
        console.log('forum/removeFilterByTag', tag)
				this.set({filterByTags: this.get().filterByTags.filter(t => t.code != tag.code)})
			},
    }

  }
</script>

<svelte:head>
  <title>Forum</title>
</svelte:head>

<div class="w3-container {!$isMobile && 'w3-margin'}">

  <div class="w3-row">
    <div class="w3-col l1 s2">
      <h3 class="w3-text-teal">Forum</h3>
    </div>
    
    {#if $isAuth }
      <div class="w3-col w3-right l1 s2">
        <button class="w3-button w3-right w3-card w3-round w3-hover-light-grey" on:click="handleNew()">
          <i class="fas fa-plus w3-text-teal"/>
        </button>
      </div>
    {/if}

    <div class="w3-col l10 s8">
      <input class="w3-input w3-margin-bottom"
        placeholder="Search...  select tags below to filter"
      />
    </div>
  </div>
  <div class="tags w3-display-container">
    <div class="w3-container w3-card w3-padding w3-white">
      {#each tags as tag}
        <span class="tag pointer w3-tag w3-round w3-small {tag.selected ? 'w3-blue' : 'w3-light-grey'} w3-center" 
          on:click="setFilterByTag(event, tag)">{tag.name}</span>
      {/each}
      <div class="w3-display-topright w3-text-orange">
        <i class="fas fa-angle-down" on:click="toggleTags(event)"/>
      </div>
    </div>
  </div>
  {#if Boolean(posts)} 
    <div class="w3-margin-top">
      {#each posts as post}
        <div class="w3-row">
          <div class="w3-col m8 s9"><a class="w3-large w3-text-orange" href="/forum/{post.slug}">{post.title}</a></div>
          <div class="w3-col m4 s3">
            <span class="w3-right w3-small w3-text-grey w3-right-align">
              <span class="nowrap">{post.timestamp}</span>
              <span class="nowrap"> by <a href="/user/{post.createdBy}" class="w3-text-blue">{post.username}</a><span/>
            </span>
          </div>
        </div>
        <div><a href="/forum/{post.slug}">{@html post.html}</a></div>
        {#if post.tags}
          <div class="w3-margin-top">
            {#each post.tags as tag}
              <span class="pointer w3-tag w3-round w3-margin-right w3-tiny w3-light-grey w3-center" 
                on:click="setFilterByTag(event, tag)">{tag.name}</span>
            {/each}
          </div>
        {/if}
        <hr/>
      {/each}
    </div>
  {/if}
</div>

<style>
  hr {
    border-style: dashed;
    margin-top: 8px;
    margin-bottom: 8px;
  }

  .nowrap {
    white-space:nowrap;
  }

  .tags {
    min-height: 3rem;
  }

  .tags .w3-card {
    position: absolute;
    height: 2.6rem;
    overflow-y: hidden;
  }

  .tags:hover .w3-card {
    height: unset;
    overflow-y: unset;
    z-index: 10;
  }

  .tags i {
	  margin: 12px 10px;
	}

  .tag {
		margin: 4px 8px 8px 0px;
	}

  .tag:hover {
		margin: 4px 8px 4px 0px;
	}
</style>

<script>
  import * as sapper from '../../../__sapper__/client'

  import countries from './countries.json'
  
  export default {
    data() {
      return {
        posts: [],
        filterByTags: [],
        tags: [],
      }
    },
    
    async oncreate() {
      try {
        let res = await fetch(`/${this.store.get().CFG.API_VERSION}/forum`, {
          method: 'GET',
          credentials: 'same-origin',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        }).then(res => res.json())
        if (res.error) {
          throw res.error
        }

        res.posts.map( post => post.tags = this.sortTags(post.tags))
        this.set({ posts: res.posts })
      } catch (err) {
        this.set({ posts: [] })
      }

      this.set({tags: this.sortTags(countries)})
    },

    methods: {
			handleNew() {
        sapper.goto('/forum/_new')
      },

      // toggle tag as selected/unselected
			setFilterByTag(evt, tag) {
        evt.preventDefault()
        evt.stopPropagation()
        let tags = this.get().tags || []
				tags.map(t => {
          if( t.code === tag.code) {
            t.selected = !Boolean(t.selected)
          }
        })
        tags = this.sortTags(tags)
        this.set({tags})
      },

      // sort tags by selected/unselected then name
      sortTags(tags) {
        let selected = []
        let rest = []

        tags.map( t => Boolean(t.selected) ? selected.push(t) : rest.push(t))

        const compare = (a,b) => (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0)
        selected.sort(compare)
        rest.sort(compare)

        return selected.concat(rest)
      },

      // if mobile
			toggleTags(evt) {
				evt.preventDefault()
        evt.stopPropagation()
        let card = document.querySelector('.tags .w3-card')
        if( card.style.height === 'unset') {
          card.style['height'] = '2.6em'
          card.style['overflow-y'] = 'hidden'
        } else {
          card.style['height'] = 'unset'
          card.style['overflow-y'] = 'unset'
        }
			}
    }

  }
</script>
